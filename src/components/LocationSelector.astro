---
import { useState, useRef } from "react";
import { ChevronDown, Search, MapPin } from "lucide-react";

interface Country {
  _id: string;
  name: string;
  code: string;
  latitude: number;
  longitude: number;
}

interface State {
  _id: string;
  name: string;
  code: string;
  country: {
    _id: string;
    name: string;
    code: string;
  };
}

interface City {
  _id: string;
  name: string;
  country: {
    _id: string;
    name: string;
    code: string;
  };
  state: {
    _id: string;
    name: string;
    code: string;
  };
}

// Fetch data on the server side
export async function getStaticProps() {
  try {
    const [countriesRes, statesRes, citiesRes] = await Promise.all([
      fetch('https://test.amrita-fashions.com/api/countries'),
      fetch('https://test.amrita-fashions.com/api/states'),
      fetch('https://test.amrita-fashions.com/api/cities')
    ]);

    const countriesData = await countriesRes.json();
    const statesData = await statesRes.json();
    const citiesData = await citiesRes.json();

    return {
      props: {
        countries: countriesData.data?.countries || [],
        states: statesData.data?.states || [],
        cities: citiesData.data?.cities || []
      }
    };
  } catch (error) {
    console.error('Error fetching location data:', error);
    return {
      props: {
        countries: [],
        states: [],
        cities: []
      }
    };
  }
}

const { countries, states, cities } = Astro.props;
---

<!-- Client-side React component -->
<div id="location-selector">
<script define:vars={{ countries, states, cities }}>
{(() => {
  const LocationSelector = () => {
    const [isOpen, setIsOpen] = useState(false);
    const [selectedCountry, setSelectedCountry] = useState<Country>(countries[0] || {});
    const [selectedState, setSelectedState] = useState<State | null>(null);
    const [selectedCity, setSelectedCity] = useState<City | null>(null);
    const [countrySearch, setCountrySearch] = useState("");
    const [globalSearch, setGlobalSearch] = useState("");
    const dropdownRef = useRef<HTMLDivElement>(null);

    // Get flag emoji from country code
    const getFlagEmoji = (countryCode: string) => {
      const codePoints = countryCode
        .toUpperCase()
        .split('')
        .map(char => 127397 + char.charCodeAt(0));
      return String.fromCodePoint(...codePoints);
    };

    const filteredCountries = countries.filter((country: Country) =>
      country.name.toLowerCase().includes(countrySearch.toLowerCase())
    );

    const filteredStates = states.filter(
      (state: State) => state.country.code === selectedCountry.code
    );

    const filteredCities = selectedState
      ? cities.filter(
          (city: City) =>
            city.state._id === selectedState._id &&
            city.country.code === selectedCountry.code
        )
      : [];

    const globalSearchResults = globalSearch
      ? [
          ...countries
            .filter((c: Country) => c.name.toLowerCase().includes(globalSearch.toLowerCase()))
            .map((c: Country) => ({ type: "country" as const, data: c })),
          ...states
            .filter((s: State) => s.name.toLowerCase().includes(globalSearch.toLowerCase()))
            .map((s: State) => ({ type: "state" as const, data: s })),
          ...cities
            .filter((c: City) => c.name.toLowerCase().includes(globalSearch.toLowerCase()))
            .map((c: City) => ({ type: "city" as const, data: c })),
        ].slice(0, 8)
      : [];

    const handleCountrySelect = (country: Country) => {
      setSelectedCountry(country);
      setSelectedState(null);
      setSelectedCity(null);
    };

    const handleStateSelect = (state: State) => {
      setSelectedState(state);
      setSelectedCity(null);
    };

    const handleCitySelect = (city: City) => {
      setSelectedCity(city);
      setIsOpen(false);
    };

    const handleGlobalSearchSelect = (
      type: "country" | "state" | "city",
      data: any
    ) => {
      if (type === "country") {
        handleCountrySelect(data);
      } else if (type === "state") {
        const country = countries.find((c: Country) => c.code === data.country.code);
        if (country) {
          setSelectedCountry(country);
          setSelectedState(data);
          setSelectedCity(null);
        }
      } else if (type === "city") {
        const country = countries.find((c: Country) => c.code === data.country.code);
        const state = states.find((s: State) => s._id === data.state._id);
        if (country && state) {
          setSelectedCountry(country);
          setSelectedState(state);
          setSelectedCity(data);
          setIsOpen(false);
        }
      }
      setGlobalSearch("");
    };

    return (
      <div className="relative" ref={dropdownRef}>
        <button
          onClick={() => setIsOpen(!isOpen)}
          className="flex items-center gap-2 px-4 py-2.5 bg-card hover:bg-location-hover border border-border rounded-lg transition-all duration-300 shadow-sm hover:shadow-md group"
          aria-expanded={isOpen}
          aria-haspopup="true"
          aria-label="Select country, state and city"
        >
          <span className="text-2xl transition-transform duration-300 group-hover:scale-110">
            {selectedCountry.code ? getFlagEmoji(selectedCountry.code) : "üè≥Ô∏è"}
          </span>
          <span className="font-semibold text-foreground">{selectedCountry.code || "Select"}</span>
          <ChevronDown
            className={`w-4 h-4 text-muted-foreground transition-transform duration-300 ${
              isOpen ? "rotate-180" : ""
            }`}
          />
        </button>

        {isOpen && (
          <div
            className="absolute top-full mt-2 left-0 w-[900px] bg-card border border-border rounded-xl shadow-2xl animate-slide-down overflow-hidden z-50"
            role="dialog"
            aria-label="Country, state and city selection"
          >
            <div className="p-6">
              {/* Header */}
              <div className="mb-6">
                <h3 className="text-lg font-bold text-foreground mb-4 uppercase tracking-wide">
                  Choose Your Location
                </h3>

                {/* Global Search */}
                <div className="relative">
                  <div className="relative">
                    <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-muted-foreground" />
                    <input
                      type="text"
                      value={globalSearch}
                      onChange={(e) => setGlobalSearch(e.target.value)}
                      className="w-full pl-10 pr-4 py-3 bg-secondary border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-300"
                      placeholder="Search by city, state or country"
                      aria-label="Search by city, state or country"
                    />
                  </div>

                  {globalSearchResults.length > 0 && (
                    <div className="absolute top-full mt-2 w-full bg-card border border-border rounded-lg shadow-lg max-h-64 overflow-y-auto z-10 animate-fade-in">
                      {globalSearchResults.map((result, idx) => (
                        <button
                          key={idx}
                          onClick={() =>
                            handleGlobalSearchSelect(result.type, result.data)
                          }
                          className="w-full px-4 py-3 text-left hover:bg-location-hover transition-colors duration-200 flex items-center gap-3 border-b border-border last:border-b-0"
                        >
                          <MapPin className="w-4 h-4 text-primary" />
                          <div>
                            <div className="font-medium text-foreground">
                              {result.type === "country" && result.data.name}
                              {result.type === "state" && result.data.name}
                              {result.type === "city" && result.data.name}
                            </div>
                            <div className="text-xs text-muted-foreground">
                              {result.type === "country" && "Country"}
                              {result.type === "state" &&
                                `State in ${result.data.country.name}`}
                              {result.type === "city" &&
                                `City in ${result.data.state.name}, ${result.data.country.name}`}
                            </div>
                          </div>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Three Column Layout */}
              <div className="grid grid-cols-3 gap-4">
                {/* Countries Column */}
                <div className="space-y-3">
                  <input
                    type="text"
                    value={countrySearch}
                    onChange={(e) => setCountrySearch(e.target.value)}
                    className="w-full px-3 py-2 bg-secondary border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm transition-all duration-300"
                    placeholder="Search country..."
                    aria-label="Search countries"
                  />
                  <div className="h-80 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                    {filteredCountries.map((country: Country) => (
                      <button
                        key={country._id}
                        onClick={() => handleCountrySelect(country)}
                        className={`w-full px-3 py-2.5 rounded-lg text-left transition-all duration-200 flex items-center gap-2 ${
                          selectedCountry._id === country._id
                            ? "bg-location-selected border-l-4 border-primary font-semibold"
                            : "hover:bg-location-hover"
                        }`}
                      >
                        <span className="text-xl">{getFlagEmoji(country.code)}</span>
                        <span className="text-sm text-foreground capitalize">{country.name}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* States Column */}
                <div className="space-y-3">
                  <div className="px-3 py-2 bg-secondary/50 rounded-lg">
                    <span className="text-sm font-semibold text-foreground">
                      States in {selectedCountry.name || "‚Äî"}
                    </span>
                  </div>
                  <div className="h-80 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                    {filteredStates.map((state: State) => (
                      <button
                        key={state._id}
                        onClick={() => handleStateSelect(state)}
                        className={`w-full px-3 py-2.5 rounded-lg text-left transition-all duration-200 ${
                          selectedState?._id === state._id
                            ? "bg-location-selected border-l-4 border-primary font-semibold"
                            : "hover:bg-location-hover"
                        }`}
                      >
                        <span className="text-sm text-foreground capitalize">{state.name}</span>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Cities Column */}
                <div className="space-y-3">
                  <div className="px-3 py-2 bg-secondary/50 rounded-lg">
                    <span className="text-sm font-semibold text-foreground">
                      Cities in {selectedState?.name || "‚Äî"}
                    </span>
                  </div>
                  <div className="h-80 overflow-y-auto space-y-1 pr-2 custom-scrollbar">
                    {filteredCities.map((city: City) => (
                      <button
                        key={city._id}
                        onClick={() => handleCitySelect(city)}
                        className={`w-full px-3 py-2.5 rounded-lg text-left transition-all duration-200 ${
                          selectedCity?._id === city._id
                            ? "bg-location-selected border-l-4 border-primary font-semibold"
                            : "hover:bg-location-hover"
                        }`}
                      >
                        <span className="text-sm text-foreground capitalize">{city.name}</span>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}

        <style>{`
          .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
          }
          .custom-scrollbar::-webkit-scrollbar-track {
            background: hsl(var(--secondary));
            border-radius: 3px;
          }
          .custom-scrollbar::-webkit-scrollbar-thumb {
            background: hsl(var(--primary));
            border-radius: 3px;
          }
          .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: hsl(var(--primary) / 0.8);
          }
        `}</style>
      </div>
    );
  };

  return LocationSelector;
})()}
</script>
</div>

<style>
.animate-slide-down {
  animation: slideDown 0.2s ease-out;
}

.animate-fade-in {
  animation: fadeIn 0.15s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
</style>